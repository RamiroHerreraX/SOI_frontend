<app-header-admin></app-header-admin>
<br><br>

<div class="container home-admin-container mt-5 pt-3">
  <div class="card p-4 shadow">

    <h3 class="card-title text-center mb-4">Crear Contrato de Venta</h3>

    <form [formGroup]="contratoForm" (ngSubmit)="onSubmit()">

      <!-- ========== SECCIÓN 1: BÚSQUEDA DEL LOTE ========== -->
      <h5 class="mt-3 mb-3 text-primary">1. Buscar Lote</h5>
      <div class="row g-3 bg-light p-3 rounded">

        <!-- ID Lote -->
        <div class="col-md-4">
          <label class="form-label">ID del Lote <span class="text-danger">*</span></label>
          <input type="number" formControlName="id_lote" class="form-control" (keydown)="evitarNotacion($event)">

          <div class="text-danger mt-1" *ngIf="contratoForm.get('id_lote')?.hasError('pattern')">
            Solo se permiten números.
          </div>

          <div *ngIf="contratoForm.get('id_lote')?.errors?.['loteNoDisponible']" class="text-danger mt-1">
            Este lote no está disponible (rentado, vendido o en proceso).
          </div>

          <div *ngIf="contratoForm.get('id_lote')?.errors?.['loteNoExiste']" class="text-danger mt-1">
            No existe un lote con este ID.
          </div>
        </div>

        <!-- DATOS DEL LOTE EN INPUTS READONLY -->
        <div *ngIf="loteSeleccionado" class="row mt-3">

          <div class="col-md-4">
            <label class="form-label">Manzana</label>
            <input type="text" class="form-control" [value]="loteSeleccionado.manzana" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">Número de Lote</label>
            <input type="text" class="form-control" [value]="loteSeleccionado.numlote" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">Dirección</label>
            <input type="text" class="form-control" [value]="loteSeleccionado.direccion" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">Colonia</label>
            <input type="text" class="form-control" [value]="loteSeleccionado.nombre_colonia" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">Ciudad</label>
            <input type="text" class="form-control" [value]="loteSeleccionado.nombre_ciudad" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">Estado</label>
            <input type="text" class="form-control" [value]="loteSeleccionado.nombre_estado" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">Precio</label>
            <input type="text" class="form-control" formControlName="precio_total" readonly>
          </div>

          <div class="col-md-4">
          <label class="form-label">Nombre del Propietario</label>
          <input type="text" class="form-control" [value]="loteSeleccionado?.propietario_nombre"  readonly>
        </div>

        </div>
      </div>

      <!-- ========== SECCIÓN 2: CLIENTE ========== -->
      <h5 class="mt-4 mb-3 text-primary">2. Datos del Cliente</h5>
      <div class="row g-3 bg-light p-3 rounded">

        <div class="col-md-4">
          <label class="form-label">Correo del Cliente <span class="text-danger">*</span></label>
          <input type="email" formControlName="correo_cliente" class="form-control">
          <div class="text-danger mt-1" *ngIf="contratoForm.get('correo_cliente')?.hasError('email')">
            Ingresa un correo válido.
          </div>
          <div class="text-danger mt-1" *ngIf="contratoForm.get('correo_cliente')?.errors?.['correoNoExiste']">
            No existe un cliente registrado con este correo.
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Nombre</label>
          <input type="text" formControlName="nombre" class="form-control" readonly>
        </div>

        <div class="col-md-4">
          <label class="form-label">Apellido Paterno</label>
          <input type="text" formControlName="apellido_paterno" class="form-control" readonly>
        </div>

        <div class="col-md-4">
          <label class="form-label">Apellido Materno</label>
          <input type="text" formControlName="apellido_materno" class="form-control" readonly>
        </div>

        <div class="col-md-4">
          <label class="form-label">Teléfono</label>
          <input type="text" formControlName="telefono" class="form-control" readonly>
        </div>

      </div>

      <!-- ========== SECCIÓN 3: INFORMACIÓN DEL CONTRATO ========== -->
      <h5 class="mt-4 mb-3 text-primary">3. Información del Contrato</h5>
      <div class="row g-3 bg-light p-3 rounded">

        <div class="col-md-4">
          <label class="form-label">Enganche <span class="text-danger">*</span></label>
          <input type="number" formControlName="enganche" class="form-control" (keydown)="evitarNotacion($event)">
          <div class="text-danger mt-1" *ngIf="contratoForm.get('enganche')?.hasError('pattern')">
            Solo se permiten números positivos.
          </div>

          <div class="text-danger mt-1" *ngIf="contratoForm.get('enganche')?.hasError('engancheMayor')">
            El enganche debe ser menor o igual al precio total.
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Plazo (meses) <span class="text-danger">*</span></label>
          <input type="number" formControlName="plazo_meses" class="form-control" (keydown)="evitarNotacion($event)">
          <div class="text-danger mt-1" *ngIf="contratoForm.get('plazo_meses')?.hasError('min')">
            Debe ser mínimo 1 mes.
          </div>

          <div class="text-danger mt-1" *ngIf="contratoForm.get('plazo_meses')?.hasError('max')">
            El plazo máximo permitido es 12 meses.
          </div>

          <div class="text-danger mt-1" *ngIf="contratoForm.get('plazo_meses')?.hasError('pattern')">
            Solo se permiten números enteros positivos.
          </div>
        </div>
      </div>

      <!-- ========== SECCIÓN 4: DATOS EXTRA PARA EL PDF (NO SE GUARDAN EN BD) ========== -->
<h5 class="mt-4 mb-3 text-primary">4. Información Adicional del Predio</h5>
<div class="row g-3 bg-light p-3 rounded">

  <div class="col-md-6">
    <label class="form-label">Nombre del Predio</label>
    <input type="text" formControlName="nombre_predio" class="form-control">

    <div *ngIf="contratoForm.get('nombre_predio')?.touched && contratoForm.get('nombre_predio')?.invalid" class="text-danger small">
    <div *ngIf="contratoForm.get('nombre_predio')?.errors?.['required']">
      El nombre del predio es obligatorio.
    </div>
    <div *ngIf="contratoForm.get('nombre_predio')?.errors?.['minlength']">
      Debe tener al menos 3 caracteres.
    </div>
    <div *ngIf="contratoForm.get('nombre_predio')?.errors?.['pattern']">
      Solo se permiten letras y espacios.
    </div>
  </div>
  </div>

    <h6 class="mt-3">Acreditando la propiedad con:</h6>

  <div class="col-md-6">
    <label class="form-label">Tipo de Documento</label>
    <input type="text" formControlName="tipo_documento" class="form-control">

    <div *ngIf="contratoForm.get('tipo_documento')?.touched && contratoForm.get('tipo_documento')?.invalid" class="text-danger small">
    <div *ngIf="contratoForm.get('tipo_documento')?.errors?.['required']">
      El tipo de documento es obligatorio.
    </div>
    <div *ngIf="contratoForm.get('nombre_predio')?.errors?.['pattern']">
      Solo se permiten letras y espacios.
    </div>
  </div>
  </div>

  <div class="col-md-4">
    <label class="form-label">Número / Folio de Escritura</label>
    <input type="text" formControlName="folio_escritura" class="form-control">
    <div *ngIf="contratoForm.get('folio_escritura')?.touched && contratoForm.get('folio_escritura')?.invalid" class="text-danger small">
    <div *ngIf="contratoForm.get('folio_escritura')?.errors?.['required']">
      El número o folio de escritura es obligatorio.
    </div>
    <div *ngIf="contratoForm.get('folio_escritura')?.errors?.['minlength']">
      Debe tener al menos 3 caracteres.
    </div>
  </div>

  </div>

  <div class="col-md-4">
    <label class="form-label">Fecha de Emisión</label>
    <input type="date" formControlName="fecha_emision" class="form-control">
    <div *ngIf="contratoForm.get('fecha_emision')?.touched && contratoForm.get('fecha_emision')?.invalid" class="text-danger small">
    <div *ngIf="contratoForm.get('fecha_emision')?.errors?.['required']">
      La fecha de emisión es obligatoria.
    </div>
    <div *ngIf="contratoForm.get('fecha_emision')?.errors?.['fechaFutura']">
      La fecha no puede ser mayor a la fecha actual.
    </div>
</div>

  </div>

  <div class="col-md-4">
    <label class="form-label">Registro Público (folios)</label>
    <input type="text" formControlName="registro_publico" class="form-control">
    <div *ngIf="contratoForm.get('registro_publico')?.touched && contratoForm.get('registro_publico')?.invalid" class="text-danger small">
    <div *ngIf="contratoForm.get('registro_publico')?.errors?.['pattern']">
      Solo se permiten letras, números y guiones.
    </div>
</div>

  </div>

  <h6 class="mt-3">Colindancias del Terreno</h6>

  <div class="col-md-3">
    <label class="form-label">Norte</label>
    <input type="text" formControlName="colindancia_norte" class="form-control">
    <div *ngIf="contratoForm.get('colindancia_norte')?.touched && contratoForm.get('colindancia_norte')?.invalid" class="text-danger small">
    <div *ngIf="contratoForm.get('colindancia_norte')?.errors?.['minlength']">
      La colindancia debe tener al menos 3 caracteres.
    </div>
</div>

  </div>

  <div class="col-md-3">
    <label class="form-label">Sur</label>
    <input type="text" formControlName="colindancia_sur" class="form-control">
    <div *ngIf="contratoForm.get('colindancia_sur')?.touched && contratoForm.get('colindancia_sur')?.invalid" class="text-danger small">
    <div *ngIf="contratoForm.get('colindancia_sur')?.errors?.['minlength']">
      La colindancia debe tener al menos 3 caracteres.
    </div>
</div>

  </div>

  <div class="col-md-3">
    <label class="form-label">Este</label>
    <input type="text" formControlName="colindancia_este" class="form-control">
    <div *ngIf="contratoForm.get('colindancia_este')?.touched && contratoForm.get('colindancia_este')?.invalid" class="text-danger small">
    <div *ngIf="contratoForm.get('colindancia_este')?.errors?.['minlength']">
      La colindancia debe tener al menos 3 caracteres.
    </div>
</div>

  </div>

  <div class="col-md-3">
    <label class="form-label">Oeste</label>
    <input type="text" formControlName="colindancia_oeste" class="form-control">
    <div *ngIf="contratoForm.get('colindancia_oeste')?.touched && contratoForm.get('colindancia_oeste')?.invalid" class="text-danger small">
    <div *ngIf="contratoForm.get('colindancia_oeste')?.errors?.['minlength']">
      La colindancia debe tener al menos 3 caracteres.
    </div>
  </div>

  </div>

  <h6 class="mt-4">Medidas del Terreno (en metros)</h6>

<div class="col-md-3">
  <label class="form-label">Medida Norte (m)</label>
  <input type="text" formControlName="medida_norte" class="form-control">

  <div *ngIf="contratoForm.get('medida_norte')?.touched && contratoForm.get('medida_norte')?.invalid"
       class="text-danger small">
    <div *ngIf="contratoForm.get('medida_norte')?.errors?.['required']">
      La medida es obligatoria.
    </div>
    <div *ngIf="contratoForm.get('medida_norte')?.errors?.['pattern']">
      Solo se permiten números (ej. 10 o 10.5).
    </div>
  </div>
</div>

<div class="col-md-3">
  <label class="form-label">Medida Sur (m)</label>
  <input type="text" formControlName="medida_sur" class="form-control">

  <div *ngIf="contratoForm.get('medida_sur')?.touched && contratoForm.get('medida_sur')?.invalid"
       class="text-danger small">
    <div *ngIf="contratoForm.get('medida_sur')?.errors?.['required']">
      La medida es obligatoria.
    </div>
    <div *ngIf="contratoForm.get('medida_sur')?.errors?.['pattern']">
      Solo se permiten números (ej. 12 o 12.3).
    </div>
  </div>
</div>

<div class="col-md-3">
  <label class="form-label">Medida Este (m)</label>
  <input type="text" formControlName="medida_este" class="form-control">

  <div *ngIf="contratoForm.get('medida_este')?.touched && contratoForm.get('medida_este')?.invalid"
       class="text-danger small">
    <div *ngIf="contratoForm.get('medida_este')?.errors?.['required']">
      La medida es obligatoria.
    </div>
    <div *ngIf="contratoForm.get('medida_este')?.errors?.['pattern']">
      Solo se permiten números (ej. 15 o 15.8).
    </div>
  </div>
</div>

<div class="col-md-3">
  <label class="form-label">Medida Oeste (m)</label>
  <input type="text" formControlName="medida_oeste" class="form-control">

  <div *ngIf="contratoForm.get('medida_oeste')?.touched && contratoForm.get('medida_oeste')?.invalid"
       class="text-danger small">
    <div *ngIf="contratoForm.get('medida_oeste')?.errors?.['required']">
      La medida es obligatoria.
    </div>
    <div *ngIf="contratoForm.get('medida_oeste')?.errors?.['pattern']">
      Solo se permiten números (ej. 14 o 14.2).
    </div>
  </div>
</div>


</div>


      <!-- BOTONES -->
      <div class="text-center mt-4">
        <button class="btn btn-gold me-2" type="submit" 
                [disabled]="enviando || (loteSeleccionado?.estado_propiedad !== 'disponible')" >
          {{ enviando ? 'Creando...' : 'Registrar Contrato' }}
        </button>

        <button class="btn btn-silver" type="reset" 
                (click)="contratoForm.reset({estado_contrato:'activo'})">
          Limpiar
        </button>

        <div class="text-center mt-3">
        <button type="button" class="btn btn-primary me-2" (click)="generarWordContrato()">Descargar Word</button>
        <button type="button" class="btn btn-secondary" (click)="generarPDFContrato()">Descargar PDF</button>
        </div>

      </div>

    </form>

  </div>
</div>

<app-footer-admin></app-footer-admin>
